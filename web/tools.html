<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tools - MCP Jungle</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <link rel="stylesheet" href="/static/css/app.css">
    <script src="/static/js/app.js"></script>
    <script src="/static/js/components/notifications.js"></script>
    <script src="/static/js/auth.js"></script>
    <script>
        // Ensure all functions are available before Alpine.js loads
        document.addEventListener('DOMContentLoaded', function () {
            // Initialize global notifications
            if (typeof createGlobalNotifications === 'function') {
                window.globalNotifications = createGlobalNotifications();
            }
        });
    </script>
</head>

<body class="bg-gray-50" x-data="toolsApp()">
    <div class="min-h-screen">
        <!-- Navigation Header -->
        <nav class="bg-white shadow-sm border-b border-gray-200" x-data="navigationComponent()">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between h-16">
                    <div class="flex">
                        <div class="flex-shrink-0 flex items-center">
                            <h1 class="text-xl font-bold text-gray-900">MCP Jungle</h1>
                        </div>
                        <div class="hidden sm:ml-6 sm:flex sm:space-x-8">
                            <a href="/dashboard" :class="isActive('/dashboard') ? 'border-blue-500 text-gray-900' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'" class="inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium">
                                Dashboard
                            </a>
                            <a href="/servers" :class="isActive('/servers') ? 'border-blue-500 text-gray-900' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'" class="inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium">
                                Servers
                            </a>
                            <a href="/tools" :class="isActive('/tools') ? 'border-blue-500 text-gray-900' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'" class="inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium">
                                Tools
                            </a>
                            <a href="/config" :class="isActive('/config') ? 'border-blue-500 text-gray-900' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'" class="inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium">
                                Config
                            </a>
                        </div>
                    </div>
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <span :class="connectionStatus === 'connected' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'" class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium">
                                <span x-text="connectionStatus === 'connected' ? 'Online' : 'Offline'"></span>
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Notifications -->
        <div class="fixed top-4 right-4 z-50" x-data="notificationComponent()">
            <!-- Error notifications -->
            <template x-for="error in notifications.errors" :key="error.id">
                <div class="mb-2 max-w-sm w-full bg-white shadow-lg rounded-lg pointer-events-auto ring-1 ring-red-200 overflow-hidden notification-enter">
                    <div class="p-4">
                        <div class="flex items-start">
                            <div class="flex-shrink-0" x-html="getNotificationIcon('error')"></div>
                            <div class="ml-3 w-0 flex-1 pt-0.5">
                                <p class="text-sm font-medium text-gray-900" x-text="error.message"></p>
                            </div>
                            <div class="ml-4 flex-shrink-0 flex">
                                <button @click="notifications.removeError(error.id)" class="bg-white rounded-md inline-flex text-gray-400 hover:text-gray-500 focus:outline-none">
                                    <span class="sr-only">Close</span>
                                    <svg class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </template>

            <!-- Success notifications -->
            <template x-for="success in notifications.successes" :key="success.id">
                <div class="mb-2 max-w-sm w-full bg-white shadow-lg rounded-lg pointer-events-auto ring-1 ring-green-200 overflow-hidden notification-enter">
                    <div class="p-4">
                        <div class="flex items-start">
                            <div class="flex-shrink-0" x-html="getNotificationIcon('success')"></div>
                            <div class="ml-3 w-0 flex-1 pt-0.5">
                                <p class="text-sm font-medium text-gray-900" x-text="success.message"></p>
                            </div>
                            <div class="ml-4 flex-shrink-0 flex">
                                <button @click="notifications.removeSuccess(success.id)" class="bg-white rounded-md inline-flex text-gray-400 hover:text-gray-500 focus:outline-none">
                                    <span class="sr-only">Close</span>
                                    <svg class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </template>
        </div>

        <!-- Main Content -->
        <main class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
            <div class="px-4 py-6 sm:px-0">
                <!-- Page Header -->
                <div class="mb-8">
                    <h1 class="text-2xl font-bold text-gray-900">MCP Tools</h1>
                    <p class="mt-1 text-sm text-gray-600">Browse and invoke available tools from your MCP servers</p>
                </div>

                <!-- Search and Filter -->
                <div class="mb-6 bg-white p-4 rounded-lg shadow">
                    <div class="flex flex-col sm:flex-row gap-4">
                        <div class="flex-1">
                            <input type="text" x-model="searchQuery" @input="filterTools()" placeholder="Search tools..." class="form-input">
                        </div>
                        <div class="sm:w-48">
                            <select x-model="selectedServer" @change="filterTools()" class="form-input">
                                <option value="">All Servers</option>
                                <template x-for="server in servers" :key="server">
                                    <option :value="server" x-text="server"></option>
                                </template>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Tools Grid -->
                <div x-show="loading" class="flex justify-center py-8">
                    <div class="spinner"></div>
                </div>

                <div x-show="!loading && filteredTools.length === 0" class="text-center py-12">
                    <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                    </svg>
                    <h3 class="mt-2 text-sm font-medium text-gray-900">No tools found</h3>
                    <p class="mt-1 text-sm text-gray-500">
                        <span x-show="tools.length === 0">No tools are available. Make sure you have registered MCP servers.</span>
                        <span x-show="tools.length > 0">Try adjusting your search or filter criteria.</span>
                    </p>
                    <div class="mt-6" x-show="tools.length === 0">
                        <a href="/servers" class="btn-primary">
                            Add MCP Server
                        </a>
                    </div>
                </div>

                <div x-show="!loading && filteredTools.length > 0" class="grid grid-cols-1 gap-6 sm:grid-cols-2 lg:grid-cols-3">
                    <template x-for="tool in filteredTools" :key="tool.name">
                        <div class="bg-white overflow-hidden shadow rounded-lg hover:shadow-md transition-shadow cursor-pointer" @click="selectTool(tool)">
                            <div class="px-4 py-5 sm:p-6">
                                <div class="flex items-center">
                                    <div class="flex-shrink-0">
                                        <svg class="h-8 w-8 text-purple-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                        </svg>
                                    </div>
                                    <div class="ml-5 w-0 flex-1">
                                        <h3 class="text-lg font-medium text-gray-900 truncate" x-text="tool.name"></h3>
                                        <p class="text-sm text-gray-500" x-text="getServerName(tool)"></p>
                                    </div>
                                </div>
                                <div class="mt-4">
                                    <p class="text-sm text-gray-600 line-clamp-3" x-text="tool.description || 'No description available'"></p>
                                </div>
                                <div class="mt-4 flex justify-between items-center">
                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-purple-100 text-purple-800">
                                        Tool
                                    </span>
                                    <button class="inline-flex items-center px-3 py-1.5 border border-blue-300 text-sm font-medium rounded-md text-blue-700 bg-blue-50 hover:bg-blue-100 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-colors">
                                        <svg class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
                                        </svg>
                                        Invoke
                                    </button>
                                </div>
                            </div>
                        </div>
                    </template>
                </div>
            </div>
        </main>

        <!-- Tool Detail Modal -->
        <div x-show="selectedTool" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50" x-transition @keydown.escape="closeToolModal()">
            <div class="relative top-10 mx-auto p-6 border border-gray-200 max-w-4xl shadow-xl rounded-lg bg-white modal-content">
                <div class="mt-3">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <h3 class="text-lg font-medium text-gray-900" x-text="selectedTool?.name"></h3>
                            <p class="text-sm text-gray-500" x-text="getServerName(selectedTool)"></p>
                        </div>
                        <button @click="closeToolModal()" class="text-gray-400 hover:text-gray-600">
                            <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- Tool Information -->
                        <div>
                            <h4 class="text-md font-medium text-gray-900 mb-2">Description</h4>
                            <p class="text-sm text-gray-600 mb-4" x-text="selectedTool?.description || 'No description available'"></p>

                            <h4 class="text-md font-medium text-gray-900 mb-2">Input Schema</h4>
                            <div class="bg-gray-50 p-3 rounded-md">
                                <pre class="text-xs text-gray-700 whitespace-pre-wrap" x-text="formatSchema(selectedTool?.input_schema)"></pre>
                            </div>
                        </div>

                        <!-- Tool Invocation Form -->
                        <div>
                            <h4 class="text-md font-medium text-gray-900 mb-4">Invoke Tool</h4>
                            <form @submit.prevent="invokeTool()">
                                <div class="space-y-4" x-html="renderInputFields()"></div>

                                <div class="mt-6 flex justify-end space-x-3">
                                    <button type="button" @click="closeToolModal()" class="inline-flex items-center px-3 py-1.5 border border-300 text-sm font-medium rounded-md text-700 bg-50 hover:bg-100 focus:outline-none focus:ring-2 focus:ring-500 focus:ring-offset-2 transition-colors">
                                        Cancel
                                    </button>
                                    <button type="submit" :disabled="invoking" class="inline-flex items-center px-3 py-1.5 border border-blue-300 text-sm font-medium rounded-md text-blue-700 bg-blue-50 hover:bg-blue-100 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-colors">
                                        <svg class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
                                        </svg>
                                        <span x-show="invoking" class="spinner mr-2"></span>
                                        <span x-text="invoking ? 'Invoking...' : 'Invoke Tool'"></span>
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>

                    <!-- Results Section -->
                    <div x-show="toolResult" class="mt-6 border-t pt-6">
                        <h4 class="text-md font-medium text-gray-900 mb-2">Results</h4>
                        <div class="bg-gray-50 p-4 rounded-md">
                            <pre class="text-sm text-gray-700 whitespace-pre-wrap" x-text="formatResult(toolResult)"></pre>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        function toolsApp() {
            return {
                tools: [],
                filteredTools: [],
                servers: [],
                loading: false,
                invoking: false,
                connectionStatus: 'connected',
                searchQuery: '',
                selectedServer: '',
                selectedTool: null,
                toolInputs: {},
                toolResult: null,
                pollingInterval: null,

                init() {
                    this.loadTools();
                    this.startPolling();
                },

                async loadTools() {
                    this.loading = true;
                    try {
                        const tools = await API.get('/tools');
                        this.tools = tools || [];
                        this.filteredTools = [...this.tools];
                        this.extractServers();
                        this.connectionStatus = 'connected';
                    } catch (error) {
                        console.error('Failed to load tools:', error);
                        this.connectionStatus = 'disconnected';
                        this.showError('Failed to load tools: ' + error.message);
                    } finally {
                        this.loading = false;
                    }
                },

                extractServers() {
                    const serverSet = new Set();
                    this.tools.forEach(tool => {
                        const serverName = this.getServerName(tool);
                        if (serverName) {
                            serverSet.add(serverName);
                        }
                    });
                    this.servers = Array.from(serverSet).sort();
                },

                getServerName(tool) {
                    // Extract server name from tool name (assuming format like "server/tool")
                    if (tool && tool.name) {
                        const parts = tool.name.split('/');
                        return parts.length > 1 ? parts[0] : 'Unknown';
                    }
                    return 'Unknown';
                },

                filterTools() {
                    let filtered = [...this.tools];

                    // Filter by search query
                    if (this.searchQuery.trim()) {
                        const query = this.searchQuery.toLowerCase();
                        filtered = filtered.filter(tool =>
                            tool.name.toLowerCase().includes(query) ||
                            (tool.description && tool.description.toLowerCase().includes(query))
                        );
                    }

                    // Filter by server
                    if (this.selectedServer) {
                        filtered = filtered.filter(tool =>
                            this.getServerName(tool) === this.selectedServer
                        );
                    }

                    this.filteredTools = filtered;
                },

                selectTool(tool) {
                    this.selectedTool = tool;
                    this.toolInputs = {};
                    this.toolResult = null;
                    this.generateInputFields();
                },

                closeToolModal() {
                    this.selectedTool = null;
                    this.toolInputs = {};
                    this.toolResult = null;
                },

                generateInputFields() {
                    if (!this.selectedTool?.input_schema) return;

                    try {
                        const schema = typeof this.selectedTool.input_schema === 'string'
                            ? JSON.parse(this.selectedTool.input_schema)
                            : this.selectedTool.input_schema;

                        if (schema.properties) {
                            Object.keys(schema.properties).forEach(key => {
                                this.toolInputs[key] = '';
                            });
                        }
                    } catch (error) {
                        console.error('Failed to parse input schema:', error);
                    }
                },

                renderInputFields() {
                    if (!this.selectedTool?.input_schema) {
                        return '<div class="text-center py-4"><p class="text-sm text-gray-500">No input parameters required</p></div>';
                    }

                    try {
                        const schema = typeof this.selectedTool.input_schema === 'string'
                            ? JSON.parse(this.selectedTool.input_schema)
                            : this.selectedTool.input_schema;

                        if (!schema.properties) {
                            return '<div class="text-center py-4"><p class="text-sm text-gray-500">No input parameters required</p></div>';
                        }

                        let html = '';
                        Object.entries(schema.properties).forEach(([key, prop]) => {
                            const required = schema.required && schema.required.includes(key);
                            const type = prop.type || 'string';
                            const placeholder = prop.example || prop.default || `Enter ${key}...`;

                            html += `
                                <div class="form-group">
                                    <label class="form-label">
                                        ${key.charAt(0).toUpperCase() + key.slice(1)}
                                        ${required ? '<span class="text-red-500 ml-1" aria-label="required">*</span>' : ''}
                                    </label>
                                    ${prop.description ? `<p class="text-xs text-gray-500 mb-2">${prop.description}</p>` : ''}
                                    <input type="${type === 'number' ? 'number' : type === 'integer' ? 'number' : 'text'}"
                                           x-model="toolInputs.${key}"
                                           class="block w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                                           placeholder="${placeholder}"
                                           ${required ? 'required' : ''}
                                           ${type === 'integer' ? 'step="1"' : ''}
                                           ${type === 'number' ? 'step="any"' : ''}>
                                </div>
                            `;
                        });

                        return html;
                    } catch (error) {
                        console.error('Failed to render input fields:', error);
                        return '<div class="text-center py-4"><p class="text-sm text-red-500">Error parsing input schema</p></div>';
                    }
                },

                async invokeTool() {
                    if (!this.selectedTool) return;

                    this.invoking = true;
                    this.toolResult = null;

                    try {
                        const payload = {
                            name: this.selectedTool.name,
                            ...this.toolInputs
                        };

                        const result = await API.post('/tools/invoke', payload);
                        this.toolResult = result;
                        this.showSuccess('Tool invoked successfully');
                    } catch (error) {
                        console.error('Failed to invoke tool:', error);
                        this.showError('Failed to invoke tool: ' + error.message);
                        this.toolResult = { error: error.message };
                    } finally {
                        this.invoking = false;
                    }
                },

                formatSchema(schema) {
                    if (!schema) return 'No schema available';
                    try {
                        const parsed = typeof schema === 'string' ? JSON.parse(schema) : schema;
                        return JSON.stringify(parsed, null, 2);
                    } catch (error) {
                        return 'Invalid schema format';
                    }
                },

                formatResult(result) {
                    if (!result) return '';
                    try {
                        return JSON.stringify(result, null, 2);
                    } catch (error) {
                        return String(result);
                    }
                },

                startPolling() {
                    // Poll every 30 seconds
                    this.pollingInterval = setInterval(() => {
                        if (!document.hidden) { // Only poll when page is visible
                            this.loadTools();
                        }
                    }, 30000);
                },

                showError(message) {
                    if (window.notifications) {
                        window.notifications.showError(message);
                    } else {
                        console.error(message);
                    }
                },

                showSuccess(message) {
                    if (window.notifications) {
                        window.notifications.showSuccess(message);
                    } else {
                        console.log(message);
                    }
                },

                destroy() {
                    if (this.pollingInterval) {
                        clearInterval(this.pollingInterval);
                    }
                }
            }
        }
    </script>
</body>

</html>